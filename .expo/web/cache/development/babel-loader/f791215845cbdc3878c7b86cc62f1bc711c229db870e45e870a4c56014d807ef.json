{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nexports.__esModule = true;\nexports.default = void 0;\nvar _logger = _interopRequireDefault(require(\"../utils/common/logger\"));\nvar RecordCache = function () {\n  function RecordCache(tableName, recordInsantiator, collection) {\n    this.map = new Map();\n    this.tableName = tableName;\n    this.recordInsantiator = recordInsantiator;\n    this._debugCollection = collection;\n  }\n  var _proto = RecordCache.prototype;\n  _proto.get = function get(id) {\n    return this.map.get(id);\n  };\n  _proto.add = function add(record) {\n    this.map.set(record.id, record);\n  };\n  _proto.delete = function _delete(record) {\n    this.map.delete(record.id);\n  };\n  _proto.unsafeClear = function unsafeClear() {\n    this.map = new Map();\n  };\n  _proto.recordsFromQueryResult = function recordsFromQueryResult(result) {\n    var _this = this;\n    return result.map(function (res) {\n      return _this.recordFromQueryResult(res);\n    });\n  };\n  _proto.recordFromQueryResult = function recordFromQueryResult(result) {\n    if ('string' === typeof result) {\n      return this._cachedModelForId(result);\n    }\n    return this._modelForRaw(result);\n  };\n  _proto.rawRecordsFromQueryResult = function rawRecordsFromQueryResult(results) {\n    var _this2 = this;\n    return results.map(function (res) {\n      if ('string' === typeof res) {\n        return _this2._cachedModelForId(res)._raw;\n      }\n      var cachedRecord = _this2.map.get(res.id);\n      return cachedRecord ? cachedRecord._raw : res;\n    });\n  };\n  _proto._cachedModelForId = function _cachedModelForId(id) {\n    var record = this.map.get(id);\n    if (!record) {\n      var message = \"Record ID \".concat(this.tableName, \"#\").concat(id, \" was sent over the bridge, but it's not cached\");\n      _logger.default.error(message);\n      try {\n        var adapter = this._debugCollection.database.adapter.underlyingAdapter;\n        if (adapter._clearCachedRecords) {\n          adapter._clearCachedRecords();\n        }\n        if (adapter._debugDignoseMissingRecord) {\n          adapter._debugDignoseMissingRecord(this.tableName, id);\n        }\n      } catch (error) {\n        _logger.default.warn(\"Ran into an error while running diagnostics:\");\n        _logger.default.warn(error);\n      }\n      throw new Error(message);\n    }\n    return record;\n  };\n  _proto._modelForRaw = function _modelForRaw(raw) {\n    var warnIfCached = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    var cachedRecord = this.map.get(raw.id);\n    if (cachedRecord) {\n      warnIfCached && _logger.default.warn(\"Record \".concat(this.tableName, \"#\").concat(cachedRecord.id, \" is cached, but full raw object was sent over the bridge\"));\n      return cachedRecord;\n    }\n    var newRecord = this.recordInsantiator(raw);\n    this.add(newRecord);\n    return newRecord;\n  };\n  return RecordCache;\n}();\nexports.default = RecordCache;","map":{"version":3,"names":["_interopRequireDefault","require","exports","__esModule","default","_logger","RecordCache","tableName","recordInsantiator","collection","map","Map","_debugCollection","_proto","prototype","get","id","add","record","set","delete","_delete","unsafeClear","recordsFromQueryResult","result","_this","res","recordFromQueryResult","_cachedModelForId","_modelForRaw","rawRecordsFromQueryResult","results","_this2","_raw","cachedRecord","message","concat","error","adapter","database","underlyingAdapter","_clearCachedRecords","_debugDignoseMissingRecord","warn","Error","raw","warnIfCached","arguments","length","undefined","newRecord"],"sources":["/app/node_modules/@nozbe/watermelondb/Collection/RecordCache.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nexports.__esModule = true;\nexports.default = void 0;\nvar _logger = _interopRequireDefault(require(\"../utils/common/logger\"));\nvar RecordCache = /*#__PURE__*/function () {\n  function RecordCache(tableName, recordInsantiator, collection) {\n    this.map = new Map();\n    this.tableName = tableName;\n    this.recordInsantiator = recordInsantiator;\n    this._debugCollection = collection;\n  }\n  var _proto = RecordCache.prototype;\n  _proto.get = function get(id) {\n    return this.map.get(id);\n  };\n  _proto.add = function add(record) {\n    this.map.set(record.id, record);\n  };\n  _proto.delete = function _delete(record) {\n    this.map.delete(record.id);\n  };\n  _proto.unsafeClear = function unsafeClear() {\n    this.map = new Map();\n  };\n  _proto.recordsFromQueryResult = function recordsFromQueryResult(result) {\n    var _this = this;\n    return result.map(function (res) {\n      return _this.recordFromQueryResult(res);\n    });\n  };\n  _proto.recordFromQueryResult = function recordFromQueryResult(result) {\n    if ('string' === typeof result) {\n      return this._cachedModelForId(result);\n    }\n    return this._modelForRaw(result);\n  };\n  _proto.rawRecordsFromQueryResult = function rawRecordsFromQueryResult(results) {\n    var _this2 = this;\n    return results.map(function (res) {\n      if ('string' === typeof res) {\n        return _this2._cachedModelForId(res)._raw;\n      }\n      var cachedRecord = _this2.map.get(res.id);\n      return cachedRecord ? cachedRecord._raw : res;\n    });\n  };\n  _proto._cachedModelForId = function _cachedModelForId(id) {\n    var record = this.map.get(id);\n    if (!record) {\n      var message = \"Record ID \".concat(this.tableName, \"#\").concat(id, \" was sent over the bridge, but it's not cached\");\n      _logger.default.error(message);\n\n      // Reaching this branch indicates a WatermelonDB/adapter bug. We should never get a record ID\n      // if we don't have it in our cache. This probably means that something crashed when adding to\n      // adapter-side cached record ID set. NozbeTeams telemetry indicates that this bug *does*\n      // nonetheless occur, so when it does, print out useful diagnostics and attempt to recover by\n      // resetting adapter-side cached set\n      try {\n        var adapter = this._debugCollection.database.adapter.underlyingAdapter;\n\n        // $FlowFixMe\n        if (adapter._clearCachedRecords) {\n          // $FlowFixMe\n          adapter._clearCachedRecords();\n        }\n\n        // $FlowFixMe\n        if (adapter._debugDignoseMissingRecord) {\n          // $FlowFixMe\n          adapter._debugDignoseMissingRecord(this.tableName, id);\n        }\n      } catch (error) {\n        _logger.default.warn(\"Ran into an error while running diagnostics:\");\n        _logger.default.warn(error);\n      }\n      throw new Error(message);\n    }\n    return record;\n  };\n  _proto._modelForRaw = function _modelForRaw(raw, warnIfCached = true) {\n    // Sanity check: is this already cached?\n    var cachedRecord = this.map.get(raw.id);\n    if (cachedRecord) {\n      // This may legitimately happen if we previously got ID without a record and we cleared\n      // adapter-side cached record ID maps to recover\n      warnIfCached && _logger.default.warn(\"Record \".concat(this.tableName, \"#\").concat(cachedRecord.id, \" is cached, but full raw object was sent over the bridge\"));\n      return cachedRecord;\n    }\n\n    // Return new model\n    var newRecord = this.recordInsantiator(raw);\n    this.add(newRecord);\n    return newRecord;\n  };\n  return RecordCache;\n}();\nexports.default = RecordCache;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}