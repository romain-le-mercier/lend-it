{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\nexports.default = subscribeToCount;\nexports.experimentalDisableObserveCountThrottling = experimentalDisableObserveCountThrottling;\nvar _rx = require(\"../../utils/rx\");\nvar _common = require(\"../../utils/common\");\nvar _Result = require(\"../../utils/fp/Result\");\nvar isThrottlingDisabled = false;\nfunction experimentalDisableObserveCountThrottling() {\n  isThrottlingDisabled = true;\n}\nfunction observeCountThrottled(query) {\n  var collection = query.collection;\n  return collection.database.withChangesForTables(query.allTables).pipe((0, _rx.throttleTime)(250), (0, _rx.switchMap)(function () {\n    return (0, _Result.toPromise)(function (callback) {\n      return collection._fetchCount(query, callback);\n    });\n  }), (0, _rx.distinctUntilChanged)());\n}\nfunction subscribeToCount(query, isThrottled, subscriber) {\n  if (isThrottled && !isThrottlingDisabled) {\n    var observable = observeCountThrottled(query);\n    var subscription = observable.subscribe(subscriber);\n    return function () {\n      return subscription.unsubscribe();\n    };\n  }\n  var collection = query.collection;\n  var unsubscribed = false;\n  var previousCount = -1;\n  var observeCountFetch = function observeCountFetch() {\n    collection._fetchCount(query, function (result) {\n      if (result.error) {\n        (0, _common.logError)(result.error.toString());\n        return;\n      }\n      var count = result.value;\n      var shouldEmit = count !== previousCount && !unsubscribed;\n      previousCount = count;\n      shouldEmit && subscriber(count);\n    });\n  };\n  var unsubscribe = collection.database.experimentalSubscribe(query.allTables, observeCountFetch, {\n    name: 'subscribeToCount',\n    query: query,\n    subscriber: subscriber\n  });\n  observeCountFetch();\n  return function () {\n    unsubscribed = true;\n    unsubscribe();\n  };\n}","map":{"version":3,"names":["exports","__esModule","default","subscribeToCount","experimentalDisableObserveCountThrottling","_rx","require","_common","_Result","isThrottlingDisabled","observeCountThrottled","query","collection","database","withChangesForTables","allTables","pipe","throttleTime","switchMap","toPromise","callback","_fetchCount","distinctUntilChanged","isThrottled","subscriber","observable","subscription","subscribe","unsubscribe","unsubscribed","previousCount","observeCountFetch","result","error","logError","toString","count","value","shouldEmit","experimentalSubscribe","name"],"sources":["/app/node_modules/@nozbe/watermelondb/observation/subscribeToCount/index.js"],"sourcesContent":["\"use strict\";\n\nexports.__esModule = true;\nexports.default = subscribeToCount;\nexports.experimentalDisableObserveCountThrottling = experimentalDisableObserveCountThrottling;\nvar _rx = require(\"../../utils/rx\");\nvar _common = require(\"../../utils/common\");\nvar _Result = require(\"../../utils/fp/Result\");\nvar isThrottlingDisabled = false;\nfunction experimentalDisableObserveCountThrottling() {\n  isThrottlingDisabled = true;\n}\n\n// Produces an observable version of a query count by re-querying the database\n// when any change occurs in any of the relevant Stores.\n//\n// TODO: Potential optimizations:\n// - increment/decrement counter using matchers on insert/delete\n\nfunction observeCountThrottled(query) {\n  var {\n    collection: collection\n  } = query;\n  return collection.database.withChangesForTables(query.allTables).pipe((0, _rx.throttleTime)(250),\n  // Note: this has a bug, but we'll delete it anyway\n  (0, _rx.switchMap)(function () {\n    return (0, _Result.toPromise)(function (callback) {\n      return collection._fetchCount(query, callback);\n    });\n  }), (0, _rx.distinctUntilChanged)());\n}\nfunction subscribeToCount(query, isThrottled, subscriber) {\n  if (isThrottled && !isThrottlingDisabled) {\n    var observable = observeCountThrottled(query);\n    var subscription = observable.subscribe(subscriber);\n    return function () {\n      return subscription.unsubscribe();\n    };\n  }\n  var {\n    collection: collection\n  } = query;\n  var unsubscribed = false;\n  var previousCount = -1;\n  var observeCountFetch = function () {\n    collection._fetchCount(query, function (result) {\n      if (result.error) {\n        (0, _common.logError)(result.error.toString());\n        return;\n      }\n      var count = result.value;\n      var shouldEmit = count !== previousCount && !unsubscribed;\n      previousCount = count;\n      shouldEmit && subscriber(count);\n    });\n  };\n  var unsubscribe = collection.database.experimentalSubscribe(query.allTables, observeCountFetch, {\n    name: 'subscribeToCount',\n    query: query,\n    subscriber: subscriber\n  });\n  observeCountFetch();\n  return function () {\n    unsubscribed = true;\n    unsubscribe();\n  };\n}"],"mappings":"AAAA,YAAY;;AAEZA,OAAO,CAACC,UAAU,GAAG,IAAI;AACzBD,OAAO,CAACE,OAAO,GAAGC,gBAAgB;AAClCH,OAAO,CAACI,yCAAyC,GAAGA,yCAAyC;AAC7F,IAAIC,GAAG,GAAGC,OAAO,iBAAiB,CAAC;AACnC,IAAIC,OAAO,GAAGD,OAAO,qBAAqB,CAAC;AAC3C,IAAIE,OAAO,GAAGF,OAAO,wBAAwB,CAAC;AAC9C,IAAIG,oBAAoB,GAAG,KAAK;AAChC,SAASL,yCAAyCA,CAAA,EAAG;EACnDK,oBAAoB,GAAG,IAAI;AAC7B;AAQA,SAASC,qBAAqBA,CAACC,KAAK,EAAE;EACpC,IACcC,UAAU,GACpBD,KAAK,CADPC,UAAU;EAEZ,OAAOA,UAAU,CAACC,QAAQ,CAACC,oBAAoB,CAACH,KAAK,CAACI,SAAS,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC,EAAEX,GAAG,CAACY,YAAY,EAAE,GAAG,CAAC,EAEhG,CAAC,CAAC,EAAEZ,GAAG,CAACa,SAAS,EAAE,YAAY;IAC7B,OAAO,CAAC,CAAC,EAAEV,OAAO,CAACW,SAAS,EAAE,UAAUC,QAAQ,EAAE;MAChD,OAAOR,UAAU,CAACS,WAAW,CAACV,KAAK,EAAES,QAAQ,CAAC;IAChD,CAAC,CAAC;EACJ,CAAC,CAAC,EAAE,CAAC,CAAC,EAAEf,GAAG,CAACiB,oBAAoB,EAAE,CAAC,CAAC;AACtC;AACA,SAASnB,gBAAgBA,CAACQ,KAAK,EAAEY,WAAW,EAAEC,UAAU,EAAE;EACxD,IAAID,WAAW,IAAI,CAACd,oBAAoB,EAAE;IACxC,IAAIgB,UAAU,GAAGf,qBAAqB,CAACC,KAAK,CAAC;IAC7C,IAAIe,YAAY,GAAGD,UAAU,CAACE,SAAS,CAACH,UAAU,CAAC;IACnD,OAAO,YAAY;MACjB,OAAOE,YAAY,CAACE,WAAW,CAAC,CAAC;IACnC,CAAC;EACH;EACA,IACchB,UAAU,GACpBD,KAAK,CADPC,UAAU;EAEZ,IAAIiB,YAAY,GAAG,KAAK;EACxB,IAAIC,aAAa,GAAG,CAAC,CAAC;EACtB,IAAIC,iBAAiB,GAAG,SAApBA,iBAAiBA,CAAA,EAAe;IAClCnB,UAAU,CAACS,WAAW,CAACV,KAAK,EAAE,UAAUqB,MAAM,EAAE;MAC9C,IAAIA,MAAM,CAACC,KAAK,EAAE;QAChB,CAAC,CAAC,EAAE1B,OAAO,CAAC2B,QAAQ,EAAEF,MAAM,CAACC,KAAK,CAACE,QAAQ,CAAC,CAAC,CAAC;QAC9C;MACF;MACA,IAAIC,KAAK,GAAGJ,MAAM,CAACK,KAAK;MACxB,IAAIC,UAAU,GAAGF,KAAK,KAAKN,aAAa,IAAI,CAACD,YAAY;MACzDC,aAAa,GAAGM,KAAK;MACrBE,UAAU,IAAId,UAAU,CAACY,KAAK,CAAC;IACjC,CAAC,CAAC;EACJ,CAAC;EACD,IAAIR,WAAW,GAAGhB,UAAU,CAACC,QAAQ,CAAC0B,qBAAqB,CAAC5B,KAAK,CAACI,SAAS,EAAEgB,iBAAiB,EAAE;IAC9FS,IAAI,EAAE,kBAAkB;IACxB7B,KAAK,EAAEA,KAAK;IACZa,UAAU,EAAEA;EACd,CAAC,CAAC;EACFO,iBAAiB,CAAC,CAAC;EACnB,OAAO,YAAY;IACjBF,YAAY,GAAG,IAAI;IACnBD,WAAW,CAAC,CAAC;EACf,CAAC;AACH","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}