{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nexports.__esModule = true;\nexports.executeCount = executeCount;\nexports.executeQuery = executeQuery;\nvar _encodeQuery = _interopRequireDefault(require(\"./encodeQuery\"));\nvar _performJoins = _interopRequireDefault(require(\"./performJoins\"));\nfunction performJoin(join, loki) {\n  var table = join.table,\n    query = join.query;\n  var collection = loki.getCollection(table).chain();\n  var records = collection.find(query).data();\n  return records;\n}\nfunction performQuery(query, loki) {\n  var lokiQuery = (0, _encodeQuery.default)(query);\n  var mainQuery = (0, _performJoins.default)(lokiQuery, function (join) {\n    return performJoin(join, loki);\n  });\n  var collection = loki.getCollection(query.table).chain();\n  var resultset = collection.find(mainQuery);\n  var _query$description = query.description,\n    sortBy = _query$description.sortBy,\n    take = _query$description.take,\n    skip = _query$description.skip;\n  if (sortBy.length) {\n    resultset = resultset.compoundsort(sortBy.map(function (_ref) {\n      var sortColumn = _ref.sortColumn,\n        sortOrder = _ref.sortOrder;\n      return [sortColumn, 'desc' === sortOrder];\n    }));\n  }\n  if (skip) {\n    resultset = resultset.offset(skip);\n  }\n  if (take) {\n    resultset = resultset.limit(take);\n  }\n  return resultset;\n}\nfunction executeQuery(query, loki) {\n  var lokiTransform = query.description.lokiTransform;\n  var results = performQuery(query, loki).data();\n  if (lokiTransform) {\n    return lokiTransform(results, loki);\n  }\n  return results;\n}\nfunction executeCount(query, loki) {\n  var lokiTransform = query.description.lokiTransform;\n  var resultset = performQuery(query, loki);\n  if (lokiTransform) {\n    var records = lokiTransform(resultset.data(), loki);\n    return records.length;\n  }\n  return resultset.count();\n}","map":{"version":3,"names":["_interopRequireDefault","require","exports","__esModule","executeCount","executeQuery","_encodeQuery","_performJoins","performJoin","join","loki","table","query","collection","getCollection","chain","records","find","data","performQuery","lokiQuery","default","mainQuery","resultset","_query$description","description","sortBy","take","skip","length","compoundsort","map","_ref","sortColumn","sortOrder","offset","limit","lokiTransform","results","count"],"sources":["/app/node_modules/@nozbe/watermelondb/adapters/lokijs/worker/executeQuery.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\nexports.__esModule = true;\nexports.executeCount = executeCount;\nexports.executeQuery = executeQuery;\nvar _encodeQuery = _interopRequireDefault(require(\"./encodeQuery\"));\nvar _performJoins = _interopRequireDefault(require(\"./performJoins\"));\n// Finds IDs of matching records on foreign table\nfunction performJoin(join, loki) {\n  var {\n    table: table,\n    query: query\n  } = join;\n  var collection = loki.getCollection(table).chain();\n  var records = collection.find(query).data();\n  return records;\n}\nfunction performQuery(query, loki) {\n  // Step one: perform all inner queries (JOINs) to get the single table query\n  var lokiQuery = (0, _encodeQuery.default)(query);\n  var mainQuery = (0, _performJoins.default)(lokiQuery, function (join) {\n    return performJoin(join, loki);\n  });\n\n  // Step two: fetch all records matching query\n  var collection = loki.getCollection(query.table).chain();\n  var resultset = collection.find(mainQuery);\n\n  // Step three: sort, skip, take\n  var {\n    sortBy: sortBy,\n    take: take,\n    skip: skip\n  } = query.description;\n  if (sortBy.length) {\n    resultset = resultset.compoundsort(sortBy.map(function ({\n      sortColumn: sortColumn,\n      sortOrder: sortOrder\n    }) {\n      return [sortColumn, 'desc' === sortOrder];\n    }));\n  }\n  if (skip) {\n    resultset = resultset.offset(skip);\n  }\n  if (take) {\n    resultset = resultset.limit(take);\n  }\n  return resultset;\n}\nfunction executeQuery(query, loki) {\n  var {\n    lokiTransform: lokiTransform\n  } = query.description;\n  var results = performQuery(query, loki).data();\n  if (lokiTransform) {\n    return lokiTransform(results, loki);\n  }\n  return results;\n}\nfunction executeCount(query, loki) {\n  var {\n    lokiTransform: lokiTransform\n  } = query.description;\n  var resultset = performQuery(query, loki);\n  if (lokiTransform) {\n    var records = lokiTransform(resultset.data(), loki);\n    return records.length;\n  }\n  return resultset.count();\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}